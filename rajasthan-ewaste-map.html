<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rajasthan E‑Waste Map — Single File (GeoJSON embedded)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  html,body,#map{height:100%;margin:0}
  body{display:flex;font-family:Inter,Arial,Helvetica,sans-serif}
  #map{flex:1}
  #side{width:380px;max-width:40%;padding:18px;box-sizing:border-box;background:#fff;border-left:1px solid #eee;overflow:auto}
  .card{background:#fbfbfb;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
  .title{font-weight:700;font-size:18px;margin-bottom:6px}
  .muted{color:#666;font-size:13px}
  .search{display:flex;gap:8px;margin:10px 0}
  input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd}
  button{padding:8px 10px;border-radius:6px;border:1px solid #ddd;background:#f6f6f6;cursor:pointer}
  pre{white-space:pre-wrap}
</style>
</head>
<body>
  <div id="map"></div>
  <div id="side">
    <div class="title">Rajasthan E‑Waste Recyclers (interactive)</div>
    <div class="muted">Click a district to view authorised recyclers. Map & dataset are bundled in this single HTML file for offline use.</div>

    <div class="search">
      <input id="districtSearch" placeholder="Search district (e.g. Jaipur)" type="text" />
      <button id="btnSearch">Go</button>
    </div>

    <div id="info"><p>Select a district on the map (or search and press Go).</p></div>

    <div class="card">
      <strong>Controls</strong>
      <div style="margin-top:8px">
        <button id="resetBtn">Reset view</button>
        <button id="downloadBtn">Download single-file HTML</button>
      </div>
      <p style="font-size:12px;margin-top:8px" class="muted">Tip: To add point markers for a recycler, include a <code>coords:[lat,lng]</code> field in that recycler's object in the <code>recyclers</code> dataset below.</p>
    </div>

    <div class="card">
      <strong>Legend (choropleth)</strong>
      <div id="legend" style="margin-top:8px" class="muted"></div>
    </div>

    <div class="card">
      <strong>About</strong>
      <p class="muted">This file includes a GeoJSON of Rajasthan districts and your recycler dataset. The script matches district names case-insensitively and tolerates common property names (e.g. DISTRICT, district, NAME_2, name).</p>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>

/* ========== Load Rajasthan GeoJSON from external file ==========  
   Place "rajasthan_districts.geojson" in the same folder as this HTML.  
   This replaces the huge inline RAJASTHAN_GEOJSON variable.
=================================================================*/

let geoLayer;       // will hold district polygons after loading
const markers = L.layerGroup(); // markers for recycler locations

// ---------- Your recyclers dataset ----------
const recyclers = {
  "JAIPUR": [
    {name: "M/s ETCO E-Waste Recycler Private Ltd", address: "SB-23, Shilp Bari, VKI Area, Jaipur", activity: "Recycling & Refurbishing", contact: "9829018257", email: "etcoewaste@gmail.com", capacity: "4490 MTA", capacity_num:4490, cto: "30.04.2029", hsw: "31.10.2029"},
    {name: "M/s Urban Metals", address: "Sitapura, Sanganer, Jaipur", activity: "Dismantling and Recycling", contact: "9509361443", email: "urbanmetalsindia@gmail.com", capacity: "480 MTA", capacity_num:480},
    {name: "M/s Green Web Recycling", address: "Manda-II, Chomu, Jaipur", activity: "Dismantling & Refurbishing", contact: "9982462926", email: "greenwebrecycling@gmail.com", capacity: "1050 MTA", capacity_num:1050},
    {name: "M/s Marss Recycler Private Limited", address: "Manda, Chomu, Jaipur", activity: "Dismantling & Refurbishing", contact: "9079852683", email: "marssconnect.jpr@gmail.com", capacity: "700 MTA", capacity_num:700},
    {name: "M/s Shyam E Waste Recycling", address: "Manda Industrial Area, Chomu, Jaipur", activity: "Recycling & Refurbishing", contact: "8406984597", email: "nirmalshyam.2021@gmail.com", capacity: "3450 MTA", capacity_num:3450},
    {name: "M/s Telsys Green Web Recycling Pvt. Ltd.", address: "Manda-II, Chomu, Jaipur", activity: "Recycling & Refurbishing", contact: "9782241129", email: "telsysgreenweb@gmail.com", capacity: "13200 MTA", capacity_num:13200},
    {name: "M/s HULLADEK PWL", address: "Bindayka, Sirsi, Jaipur", activity: "Recycling", contact: "7878940255", email: "hulladekpwl@gmail.com", capacity: "6600 MTA", capacity_num:6600},
    {name: "M/s S.S. Enviro Care", address: "Sarna Dungar Industrial Area, Jhotawara Extension, Jaipur", activity: "Recycling", contact: "9654463036", email: "mishank3333@gmail.com", capacity: "6600 MTA", capacity_num:6600}
  ],
  "ALWAR": [
    {name: "M/s Adatte E-Waste Management Pvt. Ltd.", address: "Karoli, Tapukara Ext, Tijara, Alwar", activity: "Recycling & Dismantling", contact: "9971395011", capacity: "1780 MTA", capacity_num:1780},
    {name: "M/s Abaad Developers Private Limited", address: "Chopanki Bhiwadi (RIICO)", activity: "Recycling & Refurbishing", contact: "9899970888", capacity: "700 MTA", capacity_num:700},
    {name: "M/s Greenlet Recyclers Private Limited", address: "Sotanala Industrial Area, Behror", activity: "Dismantling & Refurbishing", contact: "8560891100", capacity: "1500 MTA", capacity_num:1500},
    {name: "M/s Go Green Management LLP", address: "Khushkhera RIICO, Bhiwadi", activity: "Recycling", contact: "9811977521", capacity: "637 MTA", capacity_num:637},
    {name: "M/s Tanwar Traders", address: "Tijara, Bhiwadi", activity: "Recycling", contact: "9667215218", capacity: "300 MTA", capacity_num:300},
    {name: "M/s Universal E-Waste Recycling Private Limited", address: "Chopanki, Bhiwadi", activity: "Recycling & Refurbishing", contact: "9968683340", capacity: "6920 MTA", capacity_num:6920},
    {name: "M/s HM Waste Management Private Ltd.", address: "Neemrana, Behror", activity: "Recycling", contact: "9999829677", capacity: "3300 MTA", capacity_num:3300},
    {name: "M/s Ramdass Trading Company", address: "MIA, Ramgarh, Alwar", activity: "Recycling", contact: "9352208422", capacity: "180 MTA", capacity_num:180},
    {name: "M/s Greenscape Eco Management Pvt. Ltd.", address: "MIA Alwar", activity: "Dismantling/Segregation & Recycling/Refurbishing", contact: "8290333347", capacity: "73494 MTA", capacity_num:73494}
  ],
  "SIKAR": [ {name: "M/s GS International", contact: "9928274008", capacity: "600 MTA", capacity_num:600}, {name: "M/s Golden Green Recyclers", contact: "9829405710", capacity: "750 MTA", capacity_num:750} ],
  "BARMER": [ {name: "M/s Fateh Enviro Lab", contact: "9413880789", capacity: "350 MTA", capacity_num:350} ],
  "CHURU": [ {name: "M/s SAS Tech E-waste Recycling Solutions", contact: "7976054127", capacity: "1050 MTA", capacity_num:1050} ],
  "DHOLPUR": [ {name: "M/s The Global Metalists", contact: "8800869039", capacity: "604 MTA", capacity_num:604}, {name: "M/s Rohit Pigments Industries Pvt. Ltd.", contact: "8769609584", capacity: "200 MTA", capacity_num:200} ]
};

// ---------- Utility: normalize district names ----------
function getFeatureDistrictName(feature){
  const p = feature.properties || {};
  const keys = ['DISTRICT','district','NAME_2','name','NAME','NAME_1','DIST_NAME','DIST'];
  for(const k of keys){ if(p[k]) return p[k].toString().trim(); }
  if(feature.id) return feature.id.toString();
  return 'UNKNOWN';
}
// ---------- Compute District Totals ----------
function computeDistrictTotals(recyclers){
  const totals = {};
  for(const [dist, list] of Object.entries(recyclers)){
    let sum = 0; for(const r of list){ sum += (r.capacity_num||0); }
    totals[dist.toUpperCase()] = {sum, count:list.length};
  }
  return totals;
}

const districtTotals = computeDistrictTotals(recyclers);


// ---------- Choropleth Color ----------
function getColor(d){
  return d > 20000 ? '#08306b' :
         d > 10000 ? '#08519c' :
         d > 5000  ? '#2171b5' :
         d > 2000  ? '#4292c6' :
         d > 1000  ? '#6baed6' :
         d > 500   ? '#9ecae1' :
         d > 0     ? '#c6dbef' : '#f7fbff';
}

function style(feature){
  const name = (getFeatureDistrictName(feature)||'').toUpperCase();
  const total = districtTotals[name] ? districtTotals[name].sum : 0;
  return {weight:1, color:'#444', fillOpacity:0.8, fillColor:getColor(total)};
}


// ---------- Load GeoJSON from File ----------
fetch("./rajasthan_districts.geojson")
  .then(res => res.json())
  .then(data => {
    RAJASTHAN_GEOJSON = data;
    initializeMap();
  })
  .catch(err => console.error("Failed to load Rajasthan GeoJSON:", err));

function initializeMap() {
    const map = L.map("map").setView([26.9, 75.8], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap"
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);

    const districtLayer = L.geoJSON(RAJASTHAN_GEOJSON, {
        style: {
            color: "#333",
            weight: 1,
            fillColor: "#cce5ff",
            fillOpacity: 0.6
        },

        onEachFeature: function (feature, layer) {

            layer.on("click", () => {
                const name = getDistrictName(feature).toUpperCase();
                const list = recyclers[name] || [];

                // Popup content
                let popup = `<b>${name}</b><br/>`;

                if (list.length === 0) {
                    popup += `<em>No recyclers available</em>`;
                } else {
                    popup += `<ul style="padding-left:16px;max-height:200px;overflow:auto">`;
                    popup += list
                        .map(
                            r => `
                                <li>
                                    <b>${r.name}</b><br/>
                                    ${r.activity || ""}<br/>
                                    Capacity: ${r.capacity || "N/A"}
                                </li>
                            `
                        )
                        .join("");
                    popup += "</ul>";
                }

                layer.bindPopup(popup).openPopup();

                // Update Right Side Panel
                updateSidePanel(name, list);

                // Clear old markers
                markers.clearLayers();

                // Add markers if coords exist
                for (const r of list) {
                    if (r.coords) {
                        L.marker(r.coords)
                            .addTo(markers)
                            .bindPopup(r.name);
                    }
                }
            });

            // Hover effects
            layer.on("mouseover", () => {
                layer.setStyle({ fillColor: "#99ccff" });
            });
            layer.on("mouseout", () => {
                districtLayer.resetStyle(layer);
            });
        }
    }).addTo(map);

    map.fitBounds(districtLayer.getBounds());
}

function getDistrictName(feature) {
    const p = feature.properties;
    return (
        p.DISTRICT ||
        p.district ||
        p.NAME_2 ||
        p.NAME ||
        p.name ||
        p.DIST_NAME ||
        p.DIST
    )?.toString().trim() || "UNKNOWN";
}

function updateSidePanel(name, list) {
    const panel = document.getElementById("info");
    let html = `<h3>${name}</h3>`;

    if (list.length === 0) {
        html += `<p>No recyclers available.</p>`;
    } else {
        html += list
            .map(
                r => `
                <div style="background:#fff;padding:8px;margin-bottom:10px;border-radius:6px;">
                    <strong>${r.name}</strong><br/>
                    ${r.activity || ""}<br/>
                    Address: ${r.address || "N/A"}<br/>
                    Contact: ${r.contact || "N/A"}<br/>
                    Email: ${r.email || "N/A"}<br/>
                    Capacity: ${r.capacity || "N/A"}
                </div>
            `
            )
            .join("");
    }

    panel.innerHTML = html;
}

// ---------- Feature Events ----------
function onEachFeature(feature, layer){
  const nameRaw = getFeatureDistrictName(feature);
  const name = nameRaw ? nameRaw.trim() : "UNKNOWN";
  const key = name.toUpperCase();

  layer.on({
    mouseover: e => e.target.setStyle({weight:2, color:'#000'}),
    mouseout:  e => geoLayer.resetStyle(e.target),
    click:     e => {
      const list = recyclers[key] || [];
      const popup = [];

      popup.push(`<strong>${name}</strong>`);
      if(list.length === 0){
        popup.push('<div><em>No recyclers found.</em></div>');
      } else {
        popup.push('<ul style="max-height:200px;overflow:auto;padding-left:14px">');
        popup.push(
          list.map(it => `
            <li>
              <strong>${it.name}</strong><br/>
              ${it.activity || ''}<br/>
              Contact: ${it.contact || 'N/A'}<br/>
              Capacity: ${it.capacity || 'N/A'}
            </li>
          `).join('')
        );
        popup.push('</ul>');
      }

      layer.bindPopup(popup.join('')).openPopup();
      populateSidePanel(name, list);

      markers.clearLayers();
      for(const r of list){
        if(r.coords) L.marker(r.coords).addTo(markers).bindPopup(r.name);
      }
    }
  });
}


// ---------- Side Panel ----------
function populateSidePanel(name, list){
  const info = document.getElementById('info');
  let html = `<h3>${name}</h3>`;

  if(!list || list.length === 0){
    html += "<p>No recyclers available.</p>";
  } else {
    html += list.map(it => `
      <div style="margin-bottom:10px;padding:8px;background:#fff;border-radius:6px;">
        <strong>${it.name}</strong>
        <div>${it.activity || ''}</div>
        <div>Address: ${it.address || 'N/A'}</div>
        <div>Contact: ${it.contact || 'N/A'}</div>
        <div>Email: ${it.email || 'N/A'}</div>
        <div>Capacity: ${it.capacity || 'N/A'}</div>
      </div>
    `).join('');
  }

  info.innerHTML = html;
}


// ---------- Search ----------
document.getElementById('btnSearch').addEventListener('click', ()=>{
  const q = document.getElementById('districtSearch').value.trim().toUpperCase();
  if(!q) return;

  let found = false;

  geoLayer.eachLayer(layer => {
    const name = getFeatureDistrictName(layer.feature).trim().toUpperCase();
    if(name === q){
      map.fitBounds(layer.getBounds(),{maxZoom:10});
      layer.fire('click');
      found = true;
    }
  });

  if(!found) alert("District not found.");
});

document.getElementById('districtSearch').addEventListener('keydown', e=>{
  if(e.key === 'Enter') document.getElementById('btnSearch').click();
});


// ---------- Reset ----------
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(geoLayer) map.fitBounds(geoLayer.getBounds());
  markers.clearLayers();
  document.getElementById('info').innerHTML = "<p>Select a district.</p>";
});

</script>

</body>
</html>
